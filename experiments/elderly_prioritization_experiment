"""
ExperimentTemplate.py

Rename to "experiment name"_experiment.py

Copy this file to create a new experiment script under ./experiments.
Replace the Intro/Methods/Results sections with experiment-specific text and analysis

Introduction should contain a brief description of the experiment

Methods should configure a run, or run variants for the experiment

Results is a section to analyze model outputs, and save them to RUN_DIR
"""
from __future__ import annotations
import os
import json
import datetime 
import numpy as np # noqa: F401
import pandas as pd # noqa: F401
import matplotlib # noqa: F401
import matplotlib.pyplot as plt # noqa: F401

from scripts.model_driver import prepare_contacts, run_variants, run_single_model  # noqa: F401
from scripts.network_model import DefaultModelParams, EqualPriority, RandomPriority, PrioritizeElders, CallIndividualsAction # noqa: F401
from scripts.analysis_tools import *

# --------------------------
#       INTRODUCTION
# --------------------------
EXPERIMENT_NAME = "elderly_prioritization"
DESCRIPTION = """
Tests variants of models that prioritize calling elderly citizens over non-elderly.

- Variant One will conduct zero calls.
- Variant Two will conduct random calls.
- Variant Three will conduct calls prioritizing elderly individuals 65+
- These calls are assumed to take slightly longer, as they are elderly individuals
"""

# --------------------------
#          METHODS
# --------------------------
#Set the base parameters to be used for runs
#Update BASE_PARAMS with values to be non-default
BASE_PARAMS = DefaultModelParams.copy()
BASE_PARAMS.update({
    "n_runs": 100,
    "simulation_duration": 100,
    "seed": 2026,
    "save_data_files": True,
    "overwrite_edge_list": False,
    "run_name": "Random_Run",
    "county": "Alcona",
    "I0": [906]
})

#Results root path for this experiment
EXPERIMENT_DIR = os.path.join("experiments", "results", EXPERIMENT_NAME)
RUN_TIMESTAMP = datetime.datetime.now().strftime("%Y%m%dT%H%M%SEST")
RUN_DIR = os.path.join(EXPERIMENT_DIR, RUN_TIMESTAMP)
os.makedirs(RUN_DIR, exist_ok = True)

COUNTY = BASE_PARAMS.get("county")
STATE = BASE_PARAMS.get("state")


"""
"""

def call_action_factory(nodes, contact_type, prio, cost, params = None):
    nodes_arr = np.asarray(nodes, dtype=np.int32)
    contact_types = [contact_type] if contact_type is not None else ['cas', 'sch', 'wp']

    reduction = (
        params.get('reduction', BASE_PARAMS.get('lhd_default_int_reduction', 0.8))
        if params else BASE_PARAMS.get('lhd_default_int_reduction', 0.8)
    )
    duration = int(
        params.get('duration', BASE_PARAMS.get('lhd_default_int_duration', 10))
        if params else BASE_PARAMS.get('lhd_default_int_duration', 10)
    )
    call_cost = float(cost) if cost is not None else float(BASE_PARAMS.get('lhd_default_call_duration', 0.1))

    return CallIndividualsAction(
        nodes=nodes_arr,
        contact_types=contact_types,
        reduction=float(reduction),
        duration=int(duration),
        call_cost=float(call_cost),
        min_factor=1e-6
        )

#Define experiment variants
#each variant gets a name, a dict of params to override with matching keys to base_params, a mapping of LHD action types to algorithms, a mapping of LHD action types to action factories, and a save_exposures option

#Set base variants, which can differ in parameters, or LHD strategies
BASE_VARIANTS = [
    {
        "name": "NO_LHD",
        "param_overrides": {},
        "algorithm_map": {},
        "factory_map": {},
        "save_exposures": False,
    },
      {
        "name": "RANDOM_CALLING",
        "param_overrides": {},
        "algorithm_map": {"call": RandomPriority()},
        "factory_map": {"call": call_action_factory},
        "save_exposures": False,
    },
    {
        "name": "PRIORITIZE_ELDERLY",
        "param_overrides": {},
        "algorithm_map": {"call": PrioritizeElders()},
        "factory_map": {"call": call_action_factory},
        "save_exposures": False,
    }
]
#Sweep across parameters for each base variant
print("Generating Parameter Sweep Variants")
sweep_params = {
    "base_transmission_prob":(0,1), 
    "susceptibility_multiplier_elderly":(1,4)
}
VARIANTS = generate_lhs_variants(BASE_VARIANTS, sweep_params, n = 15)




#Save run configuration next to results
with open(os.path.join(RUN_DIR, "experiment_config.json"), "w") as f:
    json.dump({
        "name": EXPERIMENT_NAME,
        "description": DESCRIPTION,
        "base_params": BASE_PARAMS,
        "variants": VARIANTS,
        "timestamp": datetime.datetime.now(datetime.UTC).isoformat() 
    }, f, indent = 4, default = str)


# --------------------------
#         RUN MODEL
# --------------------------
#run model based on methods specifications
#Note that variants_share_edge_list MUST be set to False for different variants to have independent contact networks

print(f"Preparing contacts for county: {COUNTY}")
contacts_df = prepare_contacts(COUNTY, STATE, data_dir = "data", save_files = BASE_PARAMS["save_data_files"])

print(f"Running experiment {EXPERIMENT_NAME}")
variant_results = run_variants(
    contacts_df = contacts_df,
    base_params = BASE_PARAMS,
    variants = VARIANTS,
    run_dir = RUN_DIR,
    base_seed = BASE_PARAMS.get("seed", 2026),
    variants_share_edge_list = True
)

print("Run finished!")
# --------------------------
#          RESULTS
# --------------------------
#statistical analysis, plotting, creating results files, etc.
print("Aggregating run results...")
df, summary =  aggregate_variant_results(
    variant_results,
    name_sep = "__",
    aggregate_sweeps = True,
    aggregated_summary = True
    )

df.to_csv(os.path.join(RUN_DIR, "dataframe.csv"))
summary.to_csv(os.path.join(RUN_DIR, "aggregated_experiment_results.csv"))

#add outbreak flag, defined as 3+ confirmed cases 
#major outbreak defined as 15+ cases
df['outbreak'] = (df['total_infections'] >= 3)
df['major_outbreak'] = (df['total_infections'] >= 10)

df.insert(0, 'transmission_prob', df.pop('base_transmission_prob'))

prev_series, cum_inc_series = disease_over_time(variant_results, return_cumulative_incidence= True, return_long = True)

df.plot.scatter(x = 'transmission_prob', y = 'total_infections')
plt.show()
plt.close()

fig, axes = plot_epi_series(cum_inc_series, type = "incidence", spaghetti = False, outbreak_threshold=5, population=variant_results[0]["model"].N)
plt.show()
